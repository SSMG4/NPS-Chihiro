<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chihiro PS Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #223366 0%, #355ccc 100%);
            color: #fff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        header {
            background: rgba(0,0,0,0.50);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #2e4b9c;
        }
        header img {
            height: 48px;
        }
        header h1 {
            font-size: 2rem;
            margin: 0 0 0 1rem;
            font-weight: 700;
            letter-spacing: 2px;
            display: inline-block;
            vertical-align: middle;
        }
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
            background: rgba(24, 34, 68, 0.92);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .search-bar input, .search-bar select {
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
        }
        .search-bar input[type="text"] {
            flex: 1;
        }
        .store-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
        }
        .store-item {
            background: rgba(40, 60, 120, 0.93);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.09);
            display: flex;
            flex-direction: column;
            transition: transform .12s;
        }
        .store-item:hover {
            transform: scale(1.04);
        }
        .store-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #111;
        }
        .store-item-info {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        .store-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fffb;
        }
        .store-id {
            font-size: 0.92rem;
            color: #aac8ff;
        }
        .store-region, .store-type {
            font-size: 0.85rem;
            color: #8cc0ff;
        }
        .store-link {
            margin-top: 0.3em;
            font-size: 0.9em;
            color: #ffd966;
            text-decoration: underline;
            word-break: break-all;
        }
        .loading {
            text-align: center;
            margin: 3rem 0;
            font-size: 1.3rem;
        }
        .tsv-source {
            font-size: 0.92rem;
            color: #aaf;
            background: rgba(20,40,80,0.5);
            border-radius: 6px;
            padding: 4px 9px;
            margin-left: 1em;
        }
        @media (max-width: 600px) {
            main {
                margin: 0.5rem;
                padding: 0.5rem;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <img src="logo.png" alt="PS Store Logo" />
        <h1>Chihiro PS Store</h1>
    </header>
    <main>
        <section class="search-bar">
            <input type="text" id="search-input" placeholder="Search for a game, title id...">
            <select id="platform-select"></select>
            <select id="category-select"></select>
            <select id="region-select"></select>
            <select id="tsv-version-select">
                <option value="current">Current TSVs</option>
                <option value="pending">Pending TSVs</option>
            </select>
        </section>
        <div id="store-list" class="store-list"></div>
        <div id="loading" class="loading">Loading store data...</div>
    </main>
    <script>
    // --- Configuration ---

    // TSV file mapping, update these if more files/categories are added
    const tsvMap = {
        'current': {
            'PSV_GAMES':        { platform: 'PSV', category: 'GAMES'        },
            'PSV_DEMOS':        { platform: 'PSV', category: 'DEMOS'        },
            'PSV_UPDATES':      { platform: 'PSV', category: 'UPDATES'      },
            'PSV_THEMES':       { platform: 'PSV', category: 'THEMES'       },
            'PSV_DLCS':         { platform: 'PSV', category: 'DLCS'         },
            'PSX_GAMES':        { platform: 'PSX', category: 'GAMES'        },
            'PSM_GAMES':        { platform: 'PSM', category: 'GAMES'        },
            'PSP_GAMES':        { platform: 'PSP', category: 'GAMES'        },
            'PSP_DEMOS':        { platform: 'PSP', category: 'DEMOS'        },
            'PSP_DLCS':         { platform: 'PSP', category: 'DLCS'         },
            'PSP_UPDATES':      { platform: 'PSP', category: 'UPDATES'      },
            'PSP_THEMES':       { platform: 'PSP', category: 'THEMES'       },
            'PS3_GAMES':        { platform: 'PS3', category: 'GAMES'        },
            'PS3_DEMOS':        { platform: 'PS3', category: 'DEMOS'        },
            'PS3_DLCS':         { platform: 'PS3', category: 'DLCS'         },
            'PS3_THEMES':       { platform: 'PS3', category: 'THEMES'       },
            'PS3_AVATARS':      { platform: 'PS3', category: 'AVATARS'      },
        },
        'pending': {
            'PSV_GAMES':        { platform: 'PSV', category: 'GAMES'        },
            'PSV_DEMOS':        { platform: 'PSV', category: 'DEMOS'        },
            'PSV_UPDATES':      { platform: 'PSV', category: 'UPDATES'      },
            'PSV_THEMES':       { platform: 'PSV', category: 'THEMES'       },
            'PSV_DLCS':         { platform: 'PSV', category: 'DLCS'         },
            'PSX_GAMES':        { platform: 'PSX', category: 'GAMES'        },
            'PSM_GAMES':        { platform: 'PSM', category: 'GAMES'        },
            'PSP_GAMES':        { platform: 'PSP', category: 'GAMES'        },
            'PSP_DEMOS':        { platform: 'PSP', category: 'DEMOS'        },
            'PSP_DLCS':         { platform: 'PSP', category: 'DLCS'         },
            'PSP_UPDATES':      { platform: 'PSP', category: 'UPDATES'      },
            'PSP_THEMES':       { platform: 'PSP', category: 'THEMES'       },
            'PS3_GAMES':        { platform: 'PS3', category: 'GAMES'        },
            'PS3_DEMOS':        { platform: 'PS3', category: 'DEMOS'        },
            'PS3_DLCS':         { platform: 'PS3', category: 'DLCS'         },
            'PS3_THEMES':       { platform: 'PS3', category: 'THEMES'       },
            'PS3_AVATARS':      { platform: 'PS3', category: 'AVATARS'      },
        }
    };

    // Each tsv file will be at: /{version}/{tsvName}.tsv
    // e.g. /current/PSV_GAMES.tsv

    // --- UI selectors ---
    const storeList = document.getElementById('store-list');
    const loadingElem = document.getElementById('loading');
    const searchInput = document.getElementById('search-input');
    const platformSelect = document.getElementById('platform-select');
    const categorySelect = document.getElementById('category-select');
    const regionSelect = document.getElementById('region-select');
    const tsvVersionSelect = document.getElementById('tsv-version-select');

    // --- State ---
    let allTsvData = {}; // { tsvName: { header:[], rows:[] } }
    let mergedData = [];
    let filteredData = [];

    // --- Populate dropdowns ---
    function populateDropdowns() {
        // Platform
        const platforms = new Set();
        for (const map of Object.values(tsvMap[tsvVersionSelect.value])) {
            platforms.add(map.platform);
        }
        platformSelect.innerHTML = `<option value="">All Platforms</option>` +
            Array.from(platforms).sort().map(p => `<option value="${p}">${p}</option>`).join('');

        // Category
        const categories = new Set();
        for (const map of Object.values(tsvMap[tsvVersionSelect.value])) {
            categories.add(map.category);
        }
        categorySelect.innerHTML = `<option value="">All Categories</option>` +
            Array.from(categories).sort().map(c => `<option value="${c}">${c}</option>`).join('');

        // Region (collected after loading data)
        regionSelect.innerHTML = `<option value="">All Regions</option>`;
    }

    // --- TSV Loader and parser ---
    async function fetchAndParseTsv(tsvUrl) {
        const resp = await fetch(tsvUrl);
        if (!resp.ok) throw new Error('Could not load ' + tsvUrl);
        const text = await resp.text();
        const lines = text.trim().split('\n');
        if (!lines.length) return { header:[], rows:[] };
        const header = lines[0].split('\t');
        const rows = [];
        for (let i = 1; i < lines.length; ++i) {
            const cols = lines[i].split('\t');
            if (cols.length < 2) continue;
            const row = {};
            for (let j = 0; j < header.length; ++j) {
                row[header[j]] = cols[j] ?? '';
            }
            rows.push(row);
        }
        return { header, rows };
    }

    async function loadAllTsvs() {
        loadingElem.textContent = 'Loading store data (please wait)...';
        storeList.innerHTML = '';
        allTsvData = {};
        mergedData = [];
        filteredData = [];

        const version = tsvVersionSelect.value;
        const map = tsvMap[version];
        const promises = [];
        for (const tsvName in map) {
            const url = `/${version}/${tsvName}.tsv`;
            promises.push(
                fetchAndParseTsv(url).then(data => {
                    allTsvData[tsvName] = {
                        ...data,
                        __platform: map[tsvName].platform,
                        __category: map[tsvName].category,
                        __tsv: tsvName
                    };
                }).catch(e => {
                    // If file missing, just skip
                })
            );
        }
        await Promise.all(promises);

        // Merge all rows, add platform/category/tsvName meta for filtering
        mergedData = [];
        for (const [tsvName, tsv] of Object.entries(allTsvData)) {
            if (!tsv.rows) continue;
            for (const row of tsv.rows) {
                row.__platform = tsv.__platform;
                row.__category = tsv.__category;
                row.__tsv = tsv.__tsv;
                mergedData.push(row);
            }
        }

        // Update region dropdown with all unique regions
        const regions = new Set();
        mergedData.forEach(r => {
            if (r.Region) regions.add(r.Region);
        });
        regionSelect.innerHTML = `<option value="">All Regions</option>` +
            Array.from(regions).sort().map(r => `<option value="${r}">${r}</option>`).join('');

        loadingElem.style.display = 'none';
        filterAndRender();
    }

    // --- Filtering and rendering ---
    function filterAndRender() {
        const query = searchInput.value.trim().toLowerCase();
        const platform = platformSelect.value;
        const category = categorySelect.value;
        const region = regionSelect.value;

        filteredData = mergedData.filter(entry => {
            let matches = true;
            // Search by name/title id/content id
            if (query) {
                matches = (
                    (entry.Name && entry.Name.toLowerCase().includes(query)) ||
                    (entry['Title ID'] && entry['Title ID'].toLowerCase().includes(query)) ||
                    (entry['Content ID'] && entry['Content ID'].toLowerCase().includes(query))
                );
            }
            if (matches && platform) {
                matches = entry.__platform === platform;
            }
            if (matches && category) {
                matches = entry.__category === category;
            }
            if (matches && region) {
                matches = (entry.Region === region);
            }
            return matches;
        });

        renderStore(filteredData);
    }

    function getImageUrl(entry) {
        // Only PSV/PSP/PS3/PSX/PSM games/dlc have title id, use NPS CDN if possible
        if (entry['Title ID']) {
            return `https://nopaystation.com/ts/${entry['Title ID']}.png`;
        }
        return 'https://via.placeholder.com/320x180?text=No+Image';
    }

    function renderStore(data) {
        storeList.innerHTML = '';
        if (!data.length) {
            storeList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #fff8;">No results found.</div>';
            return;
        }
        // Only show first 60 results for perf
        const displayData = data.slice(0, 60);
        for (const entry of displayData) {
            const div = document.createElement('div');
            div.className = 'store-item';
            div.innerHTML = `
                <img src="${getImageUrl(entry)}" alt="Cover for ${(entry.Name||'').replace(/"/g, '&quot;')}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/320x180?text=No+Image';">
                <div class="store-item-info">
                    <div class="store-title">${entry.Name || 'Unknown Title'}</div>
                    <div class="store-id">${entry['Title ID'] || ''}</div>
                    <div class="store-region">Region: ${entry.Region || ''}</div>
                    <div class="store-type">Type: ${entry.__platform} ${entry.__category}</div>
                    ${entry['PKG direct link'] ? `<a class="store-link" href="${entry['PKG direct link']}" target="_blank">Download PKG</a>` : ''}
                    <span class="tsv-source">${entry.__platform} ${entry.__category}</span>
                </div>
            `;
            storeList.appendChild(div);
        }
    }

    // --- Debounce for search input ---
    let debounceTimer;
    function debounceFilter() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(filterAndRender, 200);
    }

    // --- Event listeners ---
    searchInput.addEventListener('input', debounceFilter);
    platformSelect.addEventListener('change', filterAndRender);
    categorySelect.addEventListener('change', filterAndRender);
    regionSelect.addEventListener('change', filterAndRender);
    tsvVersionSelect.addEventListener('change', () => {
        populateDropdowns();
        loadAllTsvs();
    });

    // --- Initial page load ---
    populateDropdowns();
    loadAllTsvs();

    </script>
</body>
</html>
